
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../evaluation/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.41">
    
    
      
        <title>Api reference - OpenML RAG Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#consistency-evaluation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OpenML RAG Documentation" class="md-header__button md-logo" aria-label="OpenML RAG Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenML RAG Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Api reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OpenML RAG Documentation" class="md-nav__button md-logo" aria-label="OpenML RAG Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OpenML RAG Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RAG Pipeline for OpenML
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Documentation Bot
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Documentation Bot
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Documentation%20Bot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documentation Bot
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Documentation%20Bot/api_reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Api reference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Inference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Inference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Inference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Inference/docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker container
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Inference/inference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Ollama server
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Ollama server
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ollama%20server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ollama Server
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Query processing LLM
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Query processing LLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Query%20processing%20LLM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LLM Query parsing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Query%20processing%20LLM/api_reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Structured query
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Rag Pipeline
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Rag Pipeline
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RAG Pipeline
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/general_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    General utilities
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/llm_module/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RAG LLM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/metadata_module/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metadata Module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/result_gen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Result gen
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/training/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Training
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/vector_store/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vector Store Utilities
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_9" >
        
          
          <label class="md-nav__link" for="__nav_6_9" id="__nav_6_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Developer Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_9">
            <span class="md-nav__icon md-icon"></span>
            Developer Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/Developer%20Tutorials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developer Tutorials
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/Developer%20Tutorials/change%20data%20input/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Change data input
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/Developer%20Tutorials/change%20model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Change model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/Developer%20Tutorials/create%20vectordb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Create vectordb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Rag%20Pipeline/Developer%20Tutorials/load%20vectordb%20and%20get%20results/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Load vectordb and get results
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    UI
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            UI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UI/api_reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Api reference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UI/frontend/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Frontend Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Evaluation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Evaluation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Evaluating the AI search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Api reference
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Api reference
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#consistency-evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      Consistency evaluation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consistence_eval" class="md-nav__link">
    <span class="md-ellipsis">
      consistence_eval
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#streamlit-labelling-app" class="md-nav__link">
    <span class="md-ellipsis">
      Streamlit labelling app
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#labellingapp" class="md-nav__link">
    <span class="md-ellipsis">
      labellingapp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#labellingapp.update_this_relevancy" class="md-nav__link">
    <span class="md-ellipsis">
      update_this_relevancy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="update_this_relevancy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#merging-labels" class="md-nav__link">
    <span class="md-ellipsis">
      Merging labels
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#merge_labels" class="md-nav__link">
    <span class="md-ellipsis">
      merge_labels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#merge_labels.merge_labels" class="md-nav__link">
    <span class="md-ellipsis">
      merge_labels
    </span>
  </a>
  
    <nav class="md-nav" aria-label="merge_labels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-batch-training" class="md-nav__link">
    <span class="md-ellipsis">
      Run Batch Training
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training" class="md-nav__link">
    <span class="md-ellipsis">
      run_all_training
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.ExperimentRunner" class="md-nav__link">
    <span class="md-ellipsis">
      ExperimentRunner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExperimentRunner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run_all_training.ExperimentRunner.aggregate_multiple_queries" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_multiple_queries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.ResponseParser" class="md-nav__link">
    <span class="md-ellipsis">
      ResponseParser
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ResponseParser">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run_all_training.ResponseParser.load_paths" class="md-nav__link">
    <span class="md-ellipsis">
      load_paths
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run_all_training.ResponseParser.parse_and_update_response" class="md-nav__link">
    <span class="md-ellipsis">
      parse_and_update_response
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.exp_0" class="md-nav__link">
    <span class="md-ellipsis">
      exp_0
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.exp_1" class="md-nav__link">
    <span class="md-ellipsis">
      exp_1
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.exp_2" class="md-nav__link">
    <span class="md-ellipsis">
      exp_2
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.exp_3" class="md-nav__link">
    <span class="md-ellipsis">
      exp_3
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.exp_4" class="md-nav__link">
    <span class="md-ellipsis">
      exp_4
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.get_queries" class="md-nav__link">
    <span class="md-ellipsis">
      get_queries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.ollama_setup" class="md-nav__link">
    <span class="md-ellipsis">
      ollama_setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.process_embedding_model_name_hf" class="md-nav__link">
    <span class="md-ellipsis">
      process_embedding_model_name_hf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.process_llm_model_name_ollama" class="md-nav__link">
    <span class="md-ellipsis">
      process_llm_model_name_ollama
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.process_query_elastic_search" class="md-nav__link">
    <span class="md-ellipsis">
      process_query_elastic_search
    </span>
  </a>
  
    <nav class="md-nav" aria-label="process_query_elastic_search">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#evaluation-utils" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluation Utils
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluation_utils" class="md-nav__link">
    <span class="md-ellipsis">
      evaluation_utils
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor" class="md-nav__link">
    <span class="md-ellipsis">
      EvaluationProcessor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EvaluationProcessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.add_map" class="md-nav__link">
    <span class="md-ellipsis">
      add_map
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.add_precision" class="md-nav__link">
    <span class="md-ellipsis">
      add_precision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.add_recall" class="md-nav__link">
    <span class="md-ellipsis">
      add_recall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.create_query_key_dict" class="md-nav__link">
    <span class="md-ellipsis">
      create_query_key_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.generate_results" class="md-nav__link">
    <span class="md-ellipsis">
      generate_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.load_queries_from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      load_queries_from_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.load_query_templates" class="md-nav__link">
    <span class="md-ellipsis">
      load_query_templates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.load_result_files" class="md-nav__link">
    <span class="md-ellipsis">
      load_result_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.preprocess_results" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elastic-search-eval" class="md-nav__link">
    <span class="md-ellipsis">
      Elastic Search Eval
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get_elastic_search_results" class="md-nav__link">
    <span class="md-ellipsis">
      get_elastic_search_results
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Evaluation of LLM models and techniques
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../labelling_tool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Labeling Tool
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../merging_labels/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Merging labels
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#consistency-evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      Consistency evaluation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consistence_eval" class="md-nav__link">
    <span class="md-ellipsis">
      consistence_eval
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#streamlit-labelling-app" class="md-nav__link">
    <span class="md-ellipsis">
      Streamlit labelling app
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#labellingapp" class="md-nav__link">
    <span class="md-ellipsis">
      labellingapp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#labellingapp.update_this_relevancy" class="md-nav__link">
    <span class="md-ellipsis">
      update_this_relevancy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="update_this_relevancy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#merging-labels" class="md-nav__link">
    <span class="md-ellipsis">
      Merging labels
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#merge_labels" class="md-nav__link">
    <span class="md-ellipsis">
      merge_labels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#merge_labels.merge_labels" class="md-nav__link">
    <span class="md-ellipsis">
      merge_labels
    </span>
  </a>
  
    <nav class="md-nav" aria-label="merge_labels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-batch-training" class="md-nav__link">
    <span class="md-ellipsis">
      Run Batch Training
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training" class="md-nav__link">
    <span class="md-ellipsis">
      run_all_training
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.ExperimentRunner" class="md-nav__link">
    <span class="md-ellipsis">
      ExperimentRunner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExperimentRunner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run_all_training.ExperimentRunner.aggregate_multiple_queries" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_multiple_queries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.ResponseParser" class="md-nav__link">
    <span class="md-ellipsis">
      ResponseParser
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ResponseParser">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run_all_training.ResponseParser.load_paths" class="md-nav__link">
    <span class="md-ellipsis">
      load_paths
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run_all_training.ResponseParser.parse_and_update_response" class="md-nav__link">
    <span class="md-ellipsis">
      parse_and_update_response
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.exp_0" class="md-nav__link">
    <span class="md-ellipsis">
      exp_0
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.exp_1" class="md-nav__link">
    <span class="md-ellipsis">
      exp_1
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.exp_2" class="md-nav__link">
    <span class="md-ellipsis">
      exp_2
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.exp_3" class="md-nav__link">
    <span class="md-ellipsis">
      exp_3
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.exp_4" class="md-nav__link">
    <span class="md-ellipsis">
      exp_4
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.get_queries" class="md-nav__link">
    <span class="md-ellipsis">
      get_queries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.ollama_setup" class="md-nav__link">
    <span class="md-ellipsis">
      ollama_setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.process_embedding_model_name_hf" class="md-nav__link">
    <span class="md-ellipsis">
      process_embedding_model_name_hf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.process_llm_model_name_ollama" class="md-nav__link">
    <span class="md-ellipsis">
      process_llm_model_name_ollama
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_all_training.process_query_elastic_search" class="md-nav__link">
    <span class="md-ellipsis">
      process_query_elastic_search
    </span>
  </a>
  
    <nav class="md-nav" aria-label="process_query_elastic_search">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#evaluation-utils" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluation Utils
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluation_utils" class="md-nav__link">
    <span class="md-ellipsis">
      evaluation_utils
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor" class="md-nav__link">
    <span class="md-ellipsis">
      EvaluationProcessor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EvaluationProcessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.add_map" class="md-nav__link">
    <span class="md-ellipsis">
      add_map
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.add_precision" class="md-nav__link">
    <span class="md-ellipsis">
      add_precision
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.add_recall" class="md-nav__link">
    <span class="md-ellipsis">
      add_recall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.create_query_key_dict" class="md-nav__link">
    <span class="md-ellipsis">
      create_query_key_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.generate_results" class="md-nav__link">
    <span class="md-ellipsis">
      generate_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.load_queries_from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      load_queries_from_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.load_query_templates" class="md-nav__link">
    <span class="md-ellipsis">
      load_query_templates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.load_result_files" class="md-nav__link">
    <span class="md-ellipsis">
      load_result_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.preprocess_results" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation_utils.EvaluationProcessor.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elastic-search-eval" class="md-nav__link">
    <span class="md-ellipsis">
      Elastic Search Eval
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get_elastic_search_results" class="md-nav__link">
    <span class="md-ellipsis">
      get_elastic_search_results
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Api reference</h1>

<h2 id="consistency-evaluation">Consistency evaluation<a class="headerlink" href="#consistency-evaluation" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="consistence_eval"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">











  </div>

    </div>

</div><h2 id="streamlit-labelling-app">Streamlit labelling app<a class="headerlink" href="#streamlit-labelling-app" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="labellingapp"></a>
    <div class="doc doc-contents first">

        <p>Small tool for labeling data.</p>
<p>pip install streamlit
streamlit run labellingapp.py</p>
<p>Expects the metadata csv and the topic csv in the <code>data</code> directory.</p>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="labellingapp.update_this_relevancy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_this_relevancy</span><span class="p">(</span><span class="n">var_</span><span class="p">,</span> <span class="n">topic_</span><span class="p">)</span></code>

<a href="#labellingapp.update_this_relevancy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Helper function to bind the variables to scope.</p>

            <details class="quote">
              <summary>Source code in <code>tools/labellingapp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_this_relevancy</span><span class="p">(</span><span class="n">var_</span><span class="p">,</span> <span class="n">topic_</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to bind the variables to scope.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">update_relevancy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;q</span><span class="si">{</span><span class="n">var_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">topic_</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="merging-labels">Merging labels<a class="headerlink" href="#merging-labels" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="merge_labels"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="merge_labels.merge_labels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">merge_labels</span><span class="p">()</span></code>

<a href="#merge_labels.merge_labels" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Description : Merge labels from multiple JSON label files into a single dictionary.</p>

            <details class="quote">
              <summary>Source code in <code>tools/merge_labels.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">merge_labels</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description : Merge labels from multiple JSON label files into a single dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read all files and merge them into a single dictionary</span>
    <span class="n">merged_labels</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">merged_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Remove empty lists</span>
    <span class="n">merged_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">merged_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">}</span>

    <span class="c1"># Reverse the dictionary so we have topic -&gt; [dataset_ids]</span>
    <span class="n">reversed_labels</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">merged_labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">reversed_labels</span><span class="p">[</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># Convert sets to lists for each value</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">reversed_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="run-batch-training">Run Batch Training<a class="headerlink" href="#run-batch-training" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="run_all_training"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="run_all_training.ExperimentRunner" class="doc doc-heading">
            <code>ExperimentRunner</code>


<a href="#run_all_training.ExperimentRunner" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Description: This class is used to run all the experiments. If you want to modify any behavior, change the functions in this class according to what you want.
You may also want to check out ResponseParser.</p>






              <details class="quote">
                <summary>Source code in <code>evaluation/training_utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ExperimentRunner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: This class is used to run all the experiments. If you want to modify any behavior, change the functions in this class according to what you want.</span>
<span class="sd">    You may also want to check out ResponseParser.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="n">eval_path</span><span class="p">,</span>
        <span class="n">queries</span><span class="p">,</span>
        <span class="n">list_of_embedding_models</span><span class="p">,</span>
        <span class="n">list_of_llm_models</span><span class="p">,</span>
        <span class="n">types_of_llm_apply</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subset_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cached_experiment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">custom_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">types_of_llm_apply</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">types_of_llm_apply</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_path</span> <span class="o">=</span> <span class="n">eval_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queries</span> <span class="o">=</span> <span class="n">queries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_of_embedding_models</span> <span class="o">=</span> <span class="n">list_of_embedding_models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_of_llm_models</span> <span class="o">=</span> <span class="n">list_of_llm_models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subset_ids</span> <span class="o">=</span> <span class="n">subset_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_cached_experiment</span> <span class="o">=</span> <span class="n">use_cached_experiment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_name</span> <span class="o">=</span> <span class="n">custom_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types_of_llm_apply</span> <span class="o">=</span> <span class="n">types_of_llm_apply</span>

    <span class="k">def</span> <span class="nf">run_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># across all embedding models</span>
        <span class="k">for</span> <span class="n">embedding_model</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_of_embedding_models</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Embedding Models&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">main_experiment_directory</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eval_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">process_embedding_model_name_hf</span><span class="p">(</span><span class="n">embedding_model</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">main_experiment_directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># update the config with the new experiment directories</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">main_experiment_directory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;persist_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">main_experiment_directory</span> <span class="o">/</span> <span class="s2">&quot;chroma_db&quot;</span><span class="p">)</span>

            <span class="c1"># save training details and config in a dataframe</span>
            <span class="n">config_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">config_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Hyperparameter&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">]</span>

            <span class="c1"># load the persistent database using ChromaDB</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">chromadb</span><span class="o">.</span><span class="n">PersistentClient</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;persist_dir&quot;</span><span class="p">])</span>

            <span class="c1"># Note : I was not sure how to move this to the next loop, we need the QA setup going forward..</span>
            <span class="c1"># Check if the chroma db as well as metadata files exist.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;persist_dir&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                <span class="n">main_experiment_directory</span> <span class="o">/</span> <span class="s2">&quot;all_dataset_description.csv&quot;</span>
            <span class="p">):</span>
                <span class="c1"># load the qa from the persistent database if it exists. Disabling training does this for us.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">qa_dataset_handler</span> <span class="o">=</span> <span class="n">QASetup</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">data_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type_of_data&quot;</span><span class="p">],</span>
                    <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                    <span class="n">subset_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subset_ids</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">qa_dataset</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">qa_dataset_handler</span><span class="o">.</span><span class="n">setup_vector_db_and_qa</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">qa_dataset_handler</span> <span class="o">=</span> <span class="n">QASetup</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">data_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type_of_data&quot;</span><span class="p">],</span>
                    <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                    <span class="n">subset_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subset_ids</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">qa_dataset</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">qa_dataset_handler</span><span class="o">.</span><span class="n">setup_vector_db_and_qa</span><span class="p">()</span>

            <span class="c1"># across all llm models</span>
            <span class="k">for</span> <span class="n">llm_model</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_of_llm_models</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;LLM Models&quot;</span><span class="p">):</span>
                <span class="c1"># update the config with the new embedding and llm models</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding_model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">llm_model</span>

                <span class="c1"># create a new experiment directory using a combination of the embedding model and llm model names</span>
                <span class="n">experiment_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">process_embedding_model_name_hf</span><span class="p">(</span><span class="n">embedding_model</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">process_llm_model_name_ollama</span><span class="p">(</span><span class="n">llm_model</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">experiment_path</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="c1"># main_experiment_directory / (self.custom_name + experiment_name)</span>
                        <span class="n">main_experiment_directory</span>
                        <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_name</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">experiment_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">experiment_path</span> <span class="o">=</span> <span class="n">main_experiment_directory</span> <span class="o">/</span> <span class="n">experiment_name</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">experiment_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">config_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">experiment_path</span> <span class="o">/</span> <span class="s2">&quot;config.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># we do not want to run the models again for no reason. So we use existing caches if they exit.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cached_experiment</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                    <span class="n">experiment_path</span> <span class="o">/</span> <span class="s2">&quot;results.csv&quot;</span>
                <span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Experiment </span><span class="si">{</span><span class="n">experiment_name</span><span class="si">}</span><span class="s2"> already exists. Skipping... To disable this behavior, set use_cached_experiment = False&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_metadata_path</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="s2">&quot;all_dataset_description.csv&quot;</span>
                    <span class="p">)</span>
                    <span class="n">data_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_metadata_path</span><span class="p">)</span>

                    <span class="n">combined_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_multiple_queries</span><span class="p">(</span>
                        <span class="n">qa_dataset</span><span class="o">=</span><span class="n">qa_dataset</span><span class="p">,</span>
                        <span class="n">data_metadata</span><span class="o">=</span><span class="n">data_metadata</span><span class="p">,</span>
                        <span class="n">types_of_llm_apply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">types_of_llm_apply</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">combined_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">experiment_path</span> <span class="o">/</span> <span class="s2">&quot;results.csv&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">aggregate_multiple_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qa_dataset</span><span class="p">,</span> <span class="n">data_metadata</span><span class="p">,</span> <span class="n">types_of_llm_apply</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Aggregate the results of multiple queries into a single dataframe and count the number of times a dataset appears in the results. This was done here and not in evaluate to make it a little easier to manage as each of them requires a different chroma_db and config</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">combined_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Initialize the ResponseParser once per query type</span>
        <span class="n">response_parsers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">apply_llm</span><span class="p">:</span> <span class="n">ResponseParser</span><span class="p">(</span>
                <span class="n">query_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type_of_data&quot;</span><span class="p">],</span> <span class="n">apply_llm_before_rag</span><span class="o">=</span><span class="n">apply_llm</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">apply_llm</span> <span class="ow">in</span> <span class="n">types_of_llm_apply</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">apply_llm_before_rag</span> <span class="ow">in</span> <span class="n">types_of_llm_apply</span><span class="p">:</span>
                <span class="n">combined_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span>
                    <span class="n">apply_llm_before_rag</span><span class="p">,</span>
                    <span class="n">combined_results</span><span class="p">,</span>
                    <span class="n">data_metadata</span><span class="p">,</span>
                    <span class="n">qa_dataset</span><span class="p">,</span>
                    <span class="n">query</span><span class="p">,</span>
                    <span class="n">response_parsers</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Concatenate all collected DataFrames at once</span>
        <span class="c1"># combined_df = pd.concat(combined_results, ignore_index=True)</span>

        <span class="k">return</span> <span class="n">combined_results</span>

    <span class="k">def</span> <span class="nf">run_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">apply_llm_before_rag</span><span class="p">,</span>
        <span class="n">combined_results</span><span class="p">,</span>
        <span class="n">data_metadata</span><span class="p">,</span>
        <span class="n">qa_dataset</span><span class="p">,</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="n">response_parsers</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">response_parser</span> <span class="o">=</span> <span class="n">response_parsers</span><span class="p">[</span><span class="n">apply_llm_before_rag</span><span class="p">]</span>
        <span class="n">result_data_frame</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QueryProcessor</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">qa</span><span class="o">=</span><span class="n">qa_dataset</span><span class="p">,</span>
            <span class="n">type_of_query</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_result_from_query</span><span class="p">()</span>
        <span class="n">response_parser</span><span class="o">.</span><span class="n">rag_response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;initial_response&quot;</span><span class="p">:</span> <span class="n">result_data_frame</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">response_parser</span><span class="o">.</span><span class="n">fetch_llm_response</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">result_data_frame</span> <span class="o">=</span> <span class="n">response_parser</span><span class="o">.</span><span class="n">parse_and_update_response</span><span class="p">(</span>
            <span class="n">data_metadata</span>
        <span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s2">&quot;did&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]]</span>
        <span class="n">result_data_frame</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
        <span class="n">result_data_frame</span><span class="p">[</span><span class="s2">&quot;llm_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;llm_model&quot;</span><span class="p">]</span>
        <span class="n">result_data_frame</span><span class="p">[</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;embedding_model&quot;</span><span class="p">]</span>
        <span class="n">result_data_frame</span><span class="p">[</span><span class="s2">&quot;llm_before_rag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_llm_before_rag</span>
        <span class="n">combined_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">combined_results</span><span class="p">,</span> <span class="n">result_data_frame</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">combined_results</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="run_all_training.ExperimentRunner.aggregate_multiple_queries" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_multiple_queries</span><span class="p">(</span><span class="n">qa_dataset</span><span class="p">,</span> <span class="n">data_metadata</span><span class="p">,</span> <span class="n">types_of_llm_apply</span><span class="p">)</span></code>

<a href="#run_all_training.ExperimentRunner.aggregate_multiple_queries" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Aggregate the results of multiple queries into a single dataframe and count the number of times a dataset appears in the results. This was done here and not in evaluate to make it a little easier to manage as each of them requires a different chroma_db and config</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/training_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">aggregate_multiple_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qa_dataset</span><span class="p">,</span> <span class="n">data_metadata</span><span class="p">,</span> <span class="n">types_of_llm_apply</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Aggregate the results of multiple queries into a single dataframe and count the number of times a dataset appears in the results. This was done here and not in evaluate to make it a little easier to manage as each of them requires a different chroma_db and config</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">combined_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Initialize the ResponseParser once per query type</span>
    <span class="n">response_parsers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">apply_llm</span><span class="p">:</span> <span class="n">ResponseParser</span><span class="p">(</span>
            <span class="n">query_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;type_of_data&quot;</span><span class="p">],</span> <span class="n">apply_llm_before_rag</span><span class="o">=</span><span class="n">apply_llm</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">apply_llm</span> <span class="ow">in</span> <span class="n">types_of_llm_apply</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">apply_llm_before_rag</span> <span class="ow">in</span> <span class="n">types_of_llm_apply</span><span class="p">:</span>
            <span class="n">combined_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span>
                <span class="n">apply_llm_before_rag</span><span class="p">,</span>
                <span class="n">combined_results</span><span class="p">,</span>
                <span class="n">data_metadata</span><span class="p">,</span>
                <span class="n">qa_dataset</span><span class="p">,</span>
                <span class="n">query</span><span class="p">,</span>
                <span class="n">response_parsers</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Concatenate all collected DataFrames at once</span>
    <span class="c1"># combined_df = pd.concat(combined_results, ignore_index=True)</span>

    <span class="k">return</span> <span class="n">combined_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="run_all_training.ResponseParser" class="doc doc-heading">
            <code>ResponseParser</code>


<a href="#run_all_training.ResponseParser" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code>ResponseParser</code></p>







              <details class="quote">
                <summary>Source code in <code>evaluation/training_utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ResponseParser</span><span class="p">(</span><span class="n">ResponseParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">load_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Load paths from paths.json</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../frontend/paths.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_and_update_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Parse the response from the RAG and LLM services and update the metadata based on the response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_llm_before_rag</span><span class="p">:</span>
                <span class="n">filtered_metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rag_response</span><span class="p">[</span><span class="s2">&quot;initial_response&quot;</span><span class="p">])</span>
                <span class="p">]</span>
                <span class="n">llm_parser</span> <span class="o">=</span> <span class="n">LLMResponseParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_response</span><span class="p">)</span>
                <span class="n">llm_parser</span><span class="o">.</span><span class="n">subset_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;dataset&quot;</span><span class="p">:</span>
                    <span class="n">llm_parser</span><span class="o">.</span><span class="n">get_attributes_from_response</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">llm_parser</span><span class="o">.</span><span class="n">update_subset_cols</span><span class="p">(</span><span class="n">filtered_metadata</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_llm_before_rag</span><span class="p">:</span>
                <span class="n">llm_parser</span> <span class="o">=</span> <span class="n">LLMResponseParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_response</span><span class="p">)</span>
                <span class="n">llm_parser</span><span class="o">.</span><span class="n">subset_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">llm_parser</span><span class="o">.</span><span class="n">get_attributes_from_response</span><span class="p">()</span>
                <span class="n">filtered_metadata</span> <span class="o">=</span> <span class="n">llm_parser</span><span class="o">.</span><span class="n">update_subset_cols</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">filtered_metadata</span><span class="p">[</span>
                    <span class="n">filtered_metadata</span><span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rag_response</span><span class="p">[</span><span class="s2">&quot;initial_response&quot;</span><span class="p">])</span>
                <span class="p">]</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_llm_before_rag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># if no llm response is required, return the initial response</span>
                <span class="k">return</span> <span class="n">metadata</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rag_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_query_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">metadata</span><span class="p">[[</span><span class="s2">&quot;did&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">metadata</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="run_all_training.ResponseParser.load_paths" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_paths</span><span class="p">()</span></code>

<a href="#run_all_training.ResponseParser.load_paths" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Load paths from paths.json</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/training_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Load paths from paths.json</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../frontend/paths.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="run_all_training.ResponseParser.parse_and_update_response" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_and_update_response</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span></code>

<a href="#run_all_training.ResponseParser.parse_and_update_response" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Parse the response from the RAG and LLM services and update the metadata based on the response</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/training_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_and_update_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Parse the response from the RAG and LLM services and update the metadata based on the response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_llm_before_rag</span><span class="p">:</span>
            <span class="n">filtered_metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rag_response</span><span class="p">[</span><span class="s2">&quot;initial_response&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="n">llm_parser</span> <span class="o">=</span> <span class="n">LLMResponseParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_response</span><span class="p">)</span>
            <span class="n">llm_parser</span><span class="o">.</span><span class="n">subset_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;dataset&quot;</span><span class="p">:</span>
                <span class="n">llm_parser</span><span class="o">.</span><span class="n">get_attributes_from_response</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">llm_parser</span><span class="o">.</span><span class="n">update_subset_cols</span><span class="p">(</span><span class="n">filtered_metadata</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_llm_before_rag</span><span class="p">:</span>
            <span class="n">llm_parser</span> <span class="o">=</span> <span class="n">LLMResponseParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_response</span><span class="p">)</span>
            <span class="n">llm_parser</span><span class="o">.</span><span class="n">subset_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">llm_parser</span><span class="o">.</span><span class="n">get_attributes_from_response</span><span class="p">()</span>
            <span class="n">filtered_metadata</span> <span class="o">=</span> <span class="n">llm_parser</span><span class="o">.</span><span class="n">update_subset_cols</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">filtered_metadata</span><span class="p">[</span>
                <span class="n">filtered_metadata</span><span class="p">[</span><span class="s2">&quot;did&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rag_response</span><span class="p">[</span><span class="s2">&quot;initial_response&quot;</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_llm_before_rag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if no llm response is required, return the initial response</span>
            <span class="k">return</span> <span class="n">metadata</span>
    <span class="k">elif</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rag_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_query_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">metadata</span><span class="p">[[</span><span class="s2">&quot;did&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">metadata</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="run_all_training.exp_0" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">exp_0</span><span class="p">(</span><span class="n">process_query_elastic_search</span><span class="p">,</span> <span class="n">eval_path</span><span class="p">,</span> <span class="n">query_key_dict</span><span class="p">)</span></code>

<a href="#run_all_training.exp_0" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>EXPERIMENT 0
Get results from elastic search</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/experiments.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">exp_0</span><span class="p">(</span><span class="n">process_query_elastic_search</span><span class="p">,</span> <span class="n">eval_path</span><span class="p">,</span> <span class="n">query_key_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EXPERIMENT 0</span>
<span class="sd">    Get results from elastic search</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cols = ,did,name,query,llm_model,embedding_model,llm_before_rag</span>
    <span class="c1"># for every query, get the results from elastic search</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">eval_path</span> <span class="o">/</span> <span class="s2">&quot;elasticsearch&quot;</span> <span class="o">/</span> <span class="s2">&quot;elasticsearch&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">eval_path</span> <span class="o">/</span> <span class="s2">&quot;elasticsearch&quot;</span> <span class="o">/</span> <span class="s2">&quot;elasticsearch&quot;</span><span class="p">)</span>
    <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">eval_path</span> <span class="o">/</span> <span class="s2">&quot;elasticsearch&quot;</span> <span class="o">/</span> <span class="s2">&quot;elasticsearch&quot;</span> <span class="o">/</span> <span class="s2">&quot;results.csv&quot;</span>
    <span class="c1"># check if the file exists and skip</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;did,name,query,llm_model,embedding_model,llm_before_rag</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Use ThreadPoolExecutor to parallelize requests</span>
            <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="c1"># Start a future for each query</span>
                <span class="n">futures</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                        <span class="n">process_query_elastic_search</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">dataset_id</span>
                    <span class="p">):</span> <span class="n">query</span>
                    <span class="k">for</span> <span class="n">query</span><span class="p">,</span> <span class="n">dataset_id</span> <span class="ow">in</span> <span class="n">query_key_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>

                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">)):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="c1"># Save the results to a CSV file</span>
                    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">,None,</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">,es,es,None</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="run_all_training.exp_1" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">exp_1</span><span class="p">(</span><span class="n">eval_path</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">list_of_embedding_models</span><span class="p">,</span> <span class="n">list_of_llm_models</span><span class="p">,</span> <span class="n">subset_ids</span><span class="p">,</span> <span class="n">query_key_dict</span><span class="p">)</span></code>

<a href="#run_all_training.exp_1" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>EXPERIMENT 1
Main evaluation loop that is used to run the base experiments using different models and embeddings.
Takes into account the following:
original data ingestion pipeline : combine a string of all metadata fields and the dataset description and embeds them with no pre-processing
list_of_embedding_models = [
    "BAAI/bge-large-en-v1.5",
    "BAAI/bge-base-en-v1.5",
    "Snowflake/snowflake-arctic-embed-l",
]
list_of_llm_models = ["llama3", "phi3"]
types_of_llm_apply : llm applied as filter before the RAG pipeline, llm applied as reranker after the RAG pipeline, llm not used at all</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/experiments.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">exp_1</span><span class="p">(</span>
    <span class="n">eval_path</span><span class="p">,</span>
    <span class="n">config</span><span class="p">,</span>
    <span class="n">list_of_embedding_models</span><span class="p">,</span>
    <span class="n">list_of_llm_models</span><span class="p">,</span>
    <span class="n">subset_ids</span><span class="p">,</span>
    <span class="n">query_key_dict</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EXPERIMENT 1</span>
<span class="sd">    Main evaluation loop that is used to run the base experiments using different models and embeddings.</span>
<span class="sd">    Takes into account the following:</span>
<span class="sd">    original data ingestion pipeline : combine a string of all metadata fields and the dataset description and embeds them with no pre-processing</span>
<span class="sd">    list_of_embedding_models = [</span>
<span class="sd">        &quot;BAAI/bge-large-en-v1.5&quot;,</span>
<span class="sd">        &quot;BAAI/bge-base-en-v1.5&quot;,</span>
<span class="sd">        &quot;Snowflake/snowflake-arctic-embed-l&quot;,</span>
<span class="sd">    ]</span>
<span class="sd">    list_of_llm_models = [&quot;llama3&quot;, &quot;phi3&quot;]</span>
<span class="sd">    types_of_llm_apply : llm applied as filter before the RAG pipeline, llm applied as reranker after the RAG pipeline, llm not used at all</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">expRunner</span> <span class="o">=</span> <span class="n">ExperimentRunner</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="n">eval_path</span><span class="o">=</span><span class="n">eval_path</span><span class="p">,</span>
        <span class="n">queries</span><span class="o">=</span><span class="n">query_key_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
        <span class="n">list_of_embedding_models</span><span class="o">=</span><span class="n">list_of_embedding_models</span><span class="p">,</span>
        <span class="n">list_of_llm_models</span><span class="o">=</span><span class="n">list_of_llm_models</span><span class="p">,</span>
        <span class="n">subset_ids</span><span class="o">=</span><span class="n">subset_ids</span><span class="p">,</span>
        <span class="n">use_cached_experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">expRunner</span><span class="o">.</span><span class="n">run_experiments</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="run_all_training.exp_2" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">exp_2</span><span class="p">(</span><span class="n">eval_path</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">subset_ids</span><span class="p">,</span> <span class="n">query_key_dict</span><span class="p">)</span></code>

<a href="#run_all_training.exp_2" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>EXPERIMENT 2
Evaluating temperature = 1 (default was 0.95)
Takes into account the following:
original data ingestion pipeline : combine a string of all metadata fields and the dataset description and embeds them with no pre-processing
list_of_embedding_models = [
    "BAAI/bge-large-en-v1.5",
]
list_of_llm_models = ["llama3"]
types_of_llm_apply : llm applied as filter before the RAG pipeline, llm applied as reranker after the RAG pipeline, llm not used at all</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/experiments.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">exp_2</span><span class="p">(</span><span class="n">eval_path</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">subset_ids</span><span class="p">,</span> <span class="n">query_key_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EXPERIMENT 2</span>
<span class="sd">    Evaluating temperature = 1 (default was 0.95)</span>
<span class="sd">    Takes into account the following:</span>
<span class="sd">    original data ingestion pipeline : combine a string of all metadata fields and the dataset description and embeds them with no pre-processing</span>
<span class="sd">    list_of_embedding_models = [</span>
<span class="sd">        &quot;BAAI/bge-large-en-v1.5&quot;,</span>
<span class="sd">    ]</span>
<span class="sd">    list_of_llm_models = [&quot;llama3&quot;]</span>
<span class="sd">    types_of_llm_apply : llm applied as filter before the RAG pipeline, llm applied as reranker after the RAG pipeline, llm not used at all</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">list_of_embedding_models</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;BAAI/bge-large-en-v1.5&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">list_of_llm_models</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;llama3&quot;</span><span class="p">]</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">expRunner</span> <span class="o">=</span> <span class="n">ExperimentRunner</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="n">eval_path</span><span class="o">=</span><span class="n">eval_path</span><span class="p">,</span>
        <span class="n">queries</span><span class="o">=</span><span class="n">query_key_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
        <span class="n">list_of_embedding_models</span><span class="o">=</span><span class="n">list_of_embedding_models</span><span class="p">,</span>
        <span class="n">list_of_llm_models</span><span class="o">=</span><span class="n">list_of_llm_models</span><span class="p">,</span>
        <span class="n">subset_ids</span><span class="o">=</span><span class="n">subset_ids</span><span class="p">,</span>
        <span class="n">use_cached_experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">custom_name</span><span class="o">=</span><span class="s2">&quot;temperature_1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">expRunner</span><span class="o">.</span><span class="n">run_experiments</span><span class="p">()</span>

    <span class="c1"># reset the temperature to the default value</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.95</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="run_all_training.exp_3" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">exp_3</span><span class="p">(</span><span class="n">eval_path</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">subset_ids</span><span class="p">,</span> <span class="n">query_key_dict</span><span class="p">)</span></code>

<a href="#run_all_training.exp_3" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>EXPERIMENT 3
Evaluating search type [mmr, similarity_score_threshold] (default was similarity)
Takes into account the following:
original data ingestion pipeline : combine a string of all metadata fields and the dataset description and embeds them with no pre-processing
list_of_embedding_models = [
    "BAAI/bge-large-en-v1.5",
]
list_of_llm_models = ["llama3"]
types_of_llm_apply : llm applied as reranker after the RAG pipeline</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/experiments.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">exp_3</span><span class="p">(</span><span class="n">eval_path</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">subset_ids</span><span class="p">,</span> <span class="n">query_key_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EXPERIMENT 3</span>
<span class="sd">    Evaluating search type [mmr, similarity_score_threshold] (default was similarity)</span>
<span class="sd">    Takes into account the following:</span>
<span class="sd">    original data ingestion pipeline : combine a string of all metadata fields and the dataset description and embeds them with no pre-processing</span>
<span class="sd">    list_of_embedding_models = [</span>
<span class="sd">        &quot;BAAI/bge-large-en-v1.5&quot;,</span>
<span class="sd">    ]</span>
<span class="sd">    list_of_llm_models = [&quot;llama3&quot;]</span>
<span class="sd">    types_of_llm_apply : llm applied as reranker after the RAG pipeline</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">list_of_embedding_models</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;BAAI/bge-large-en-v1.5&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">list_of_llm_models</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;llama3&quot;</span><span class="p">]</span>
    <span class="n">types_of_llm_apply</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>
    <span class="n">types_of_search</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mmr&quot;</span><span class="p">,</span> <span class="s2">&quot;similarity_score_threshold&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">type_of_search</span> <span class="ow">in</span> <span class="n">types_of_search</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;search_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_of_search</span>
        <span class="n">expRunner</span> <span class="o">=</span> <span class="n">ExperimentRunner</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">eval_path</span><span class="o">=</span><span class="n">eval_path</span><span class="p">,</span>
            <span class="n">queries</span><span class="o">=</span><span class="n">query_key_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
            <span class="n">list_of_embedding_models</span><span class="o">=</span><span class="n">list_of_embedding_models</span><span class="p">,</span>
            <span class="n">list_of_llm_models</span><span class="o">=</span><span class="n">list_of_llm_models</span><span class="p">,</span>
            <span class="n">subset_ids</span><span class="o">=</span><span class="n">subset_ids</span><span class="p">,</span>
            <span class="n">use_cached_experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">custom_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">type_of_search</span><span class="si">}</span><span class="s2">_search&quot;</span><span class="p">,</span>
            <span class="n">types_of_llm_apply</span><span class="o">=</span><span class="n">types_of_llm_apply</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expRunner</span><span class="o">.</span><span class="n">run_experiments</span><span class="p">()</span>

    <span class="c1"># reset the search type to the default value</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;search_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;similarity&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="run_all_training.exp_4" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">exp_4</span><span class="p">(</span><span class="n">eval_path</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">subset_ids</span><span class="p">,</span> <span class="n">query_key_dict</span><span class="p">)</span></code>

<a href="#run_all_training.exp_4" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>EXPERIMENT 4
Evaluating chunk size. The default is 1000, trying out 512,128
Takes into account the following:
original data ingestion pipeline : combine a string of all metadata fields and the dataset description and embeds them with no pre-processing
list_of_embedding_models = [
    "BAAI/bge-large-en-v1.5",
]
list_of_llm_models = ["llama3"]
types_of_llm_apply : llm applied as reranker after the RAG pipeline</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/experiments.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">exp_4</span><span class="p">(</span><span class="n">eval_path</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">subset_ids</span><span class="p">,</span> <span class="n">query_key_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EXPERIMENT 4</span>
<span class="sd">    Evaluating chunk size. The default is 1000, trying out 512,128</span>
<span class="sd">    Takes into account the following:</span>
<span class="sd">    original data ingestion pipeline : combine a string of all metadata fields and the dataset description and embeds them with no pre-processing</span>
<span class="sd">    list_of_embedding_models = [</span>
<span class="sd">        &quot;BAAI/bge-large-en-v1.5&quot;,</span>
<span class="sd">    ]</span>
<span class="sd">    list_of_llm_models = [&quot;llama3&quot;]</span>
<span class="sd">    types_of_llm_apply : llm applied as reranker after the RAG pipeline</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">list_of_embedding_models</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;BAAI/bge-large-en-v1.5&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">list_of_llm_models</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;llama3&quot;</span><span class="p">]</span>
    <span class="n">types_of_llm_apply</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>
    <span class="n">types_of_chunk</span> <span class="o">=</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">type_of_chunk</span> <span class="ow">in</span> <span class="n">types_of_chunk</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_of_chunk</span>
        <span class="n">expRunner</span> <span class="o">=</span> <span class="n">ExperimentRunner</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">eval_path</span><span class="o">=</span><span class="n">eval_path</span><span class="p">,</span>
            <span class="n">queries</span><span class="o">=</span><span class="n">query_key_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
            <span class="n">list_of_embedding_models</span><span class="o">=</span><span class="n">list_of_embedding_models</span><span class="p">,</span>
            <span class="n">list_of_llm_models</span><span class="o">=</span><span class="n">list_of_llm_models</span><span class="p">,</span>
            <span class="n">subset_ids</span><span class="o">=</span><span class="n">subset_ids</span><span class="p">,</span>
            <span class="n">use_cached_experiment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">custom_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">type_of_chunk</span><span class="si">}</span><span class="s2">_chunk&quot;</span><span class="p">,</span>
            <span class="n">types_of_llm_apply</span><span class="o">=</span><span class="n">types_of_llm_apply</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expRunner</span><span class="o">.</span><span class="n">run_experiments</span><span class="p">()</span>

    <span class="c1"># reset the search type to the default value</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="run_all_training.get_queries" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_queries</span><span class="p">(</span><span class="n">query_templates</span><span class="p">,</span> <span class="n">load_eval_queries</span><span class="p">)</span></code>

<a href="#run_all_training.get_queries" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get queries from the dataset templates and format it</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/training_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_queries</span><span class="p">(</span><span class="n">query_templates</span><span class="p">,</span> <span class="n">load_eval_queries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get queries from the dataset templates and format it</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query_key_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">query_templates</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">load_eval_queries</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">new_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">new_query</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_key_dict</span><span class="p">:</span>
                <span class="n">query_key_dict</span><span class="p">[</span><span class="n">new_query</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">query_key_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="run_all_training.ollama_setup" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ollama_setup</span><span class="p">(</span><span class="n">list_of_llm_models</span><span class="p">)</span></code>

<a href="#run_all_training.ollama_setup" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Description: Setup Ollama server and pull the llm_model that is being used</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/training_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ollama_setup</span><span class="p">(</span><span class="n">list_of_llm_models</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Setup Ollama server and pull the llm_model that is being used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ollama serve&amp;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for Ollama server to be active...&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ollama list | grep &#39;NAME&#39;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">for</span> <span class="n">llm_model</span> <span class="ow">in</span> <span class="n">list_of_llm_models</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ollama pull </span><span class="si">{</span><span class="n">llm_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="run_all_training.process_embedding_model_name_hf" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_embedding_model_name_hf</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

<a href="#run_all_training.process_embedding_model_name_hf" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Description: This function processes the name of the embedding model from Hugging Face to use as experiment name.</p>
<p>Input: name (str) - name of the embedding model from Hugging Face.</p>
<p>Returns: name (str) - processed name of the embedding model.</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/training_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">process_embedding_model_name_hf</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: This function processes the name of the embedding model from Hugging Face to use as experiment name.</span>

<span class="sd">    Input: name (str) - name of the embedding model from Hugging Face.</span>

<span class="sd">    Returns: name (str) - processed name of the embedding model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="run_all_training.process_llm_model_name_ollama" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_llm_model_name_ollama</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

<a href="#run_all_training.process_llm_model_name_ollama" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Description: This function processes the name of the llm model from Ollama to use as experiment name.</p>
<p>Input: name (str) - name of the llm model from Ollama.</p>
<p>Returns: name (str) - processed name of the llm model.</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/training_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">process_llm_model_name_ollama</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: This function processes the name of the llm model from Ollama to use as experiment name.</span>

<span class="sd">    Input: name (str) - name of the llm model from Ollama.</span>

<span class="sd">    Returns: name (str) - processed name of the llm model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="run_all_training.process_query_elastic_search" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_query_elastic_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">)</span></code>

<a href="#run_all_training.process_query_elastic_search" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get the results from elastic search opemml server</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/training_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">process_query_elastic_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the results from elastic search opemml server</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">get_elastic_search_results</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[(</span><span class="nb">id</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="evaluation-utils">Evaluation Utils<a class="headerlink" href="#evaluation-utils" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="evaluation_utils"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="evaluation_utils.EvaluationProcessor" class="doc doc-heading">
            <code>EvaluationProcessor</code>


<a href="#evaluation_utils.EvaluationProcessor" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">


        <p>Description: Process all the evaluated results, add the required metrics and save results as a csv/generate plots</p>






              <details class="quote">
                <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">EvaluationProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Process all the evaluated results, add the required metrics and save results as a csv/generate plots</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eval_path</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s2">&quot;precision&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;map&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_path</span> <span class="o">=</span> <span class="n">eval_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_eval_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_queries_from_csv</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_templates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_query_templates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_key_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_query_key_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_by</span> <span class="o">=</span> <span class="n">sort_by</span>

        <span class="c1"># Define a dictionary to map metric names to their corresponding methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_precision</span><span class="p">,</span>
            <span class="s2">&quot;recall&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_recall</span><span class="p">,</span>
            <span class="s2">&quot;map&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_map</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Load files, Run the evaluation process and display the results</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">csv_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_result_files</span><span class="p">()</span>
        <span class="n">results_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_results</span><span class="p">(</span><span class="n">csv_files</span><span class="p">)</span>
        <span class="n">results_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_results</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results_display</span>

    <span class="k">def</span> <span class="nf">load_result_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Find all the csv files in the evaluation directory.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_path</span> <span class="o">/</span> <span class="s2">&quot;*/*/results.csv&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">generate_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_files</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Load the results from the csv files, group them and compute metrics for each group. Then merge the results and sort them by the metric specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">exp_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">csv_files</span><span class="p">):</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">exp_path</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;did&quot;</span><span class="p">:</span> <span class="s2">&quot;y_pred&quot;</span><span class="p">})</span>
            <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;exp_folder_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">exp_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
            <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;custom_experiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="c1"># split exp_folder_name by @ to get extra information</span>
            <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;custom_experiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;exp_folder_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">exp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;exp_folder_name&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_results</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

            <span class="n">grouped_results_for_y_true_and_pred</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;embedding_model&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;llm_model&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;query&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;llm_before_rag&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;custom_experiment&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;y_true&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="s2">&quot;y_pred&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">})</span>

            <span class="n">grouped_results_for_y_true_and_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_metrics</span><span class="p">(</span>
                <span class="n">grouped_results_for_y_true_and_pred</span>
            <span class="p">)</span>

            <span class="c1"># aggregate by computing the average of the metrics for each group</span>
            <span class="n">grouped_results_for_y_true_and_pred</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">grouped_results_for_y_true_and_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;embedding_model&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;llm_model&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;llm_before_rag&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;custom_experiment&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="n">metric</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">})</span>
            <span class="p">)</span>

            <span class="c1"># merge with the results</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">grouped_results_for_y_true_and_pred</span><span class="p">])</span>

            <span class="c1"># sort by metric</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_by</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merged_df</span>

    <span class="k">def</span> <span class="nf">add_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grouped_results_for_y_true_and_pred</span><span class="p">):</span>
        <span class="c1"># Iterate over the metrics and apply the corresponding method if it exists</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_methods</span><span class="p">:</span>
                <span class="n">grouped_results_for_y_true_and_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_methods</span><span class="p">[</span><span class="n">metric</span><span class="p">](</span>
                    <span class="n">grouped_results_for_y_true_and_pred</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">grouped_results_for_y_true_and_pred</span>

    <span class="k">def</span> <span class="nf">load_queries_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Load the queries from the csv file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_path</span> <span class="o">/</span> <span class="s2">&quot;merged_labels.csv&quot;</span><span class="p">)[</span>
            <span class="p">[</span><span class="s2">&quot;Topics&quot;</span><span class="p">,</span> <span class="s2">&quot;Dataset IDs&quot;</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">load_query_templates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Load the query templates from the txt file. This is used to generate the queries for the evaluation process. eg: {query_template} {query}</span>
<span class="sd">        {find me a dataset about} {cancer}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_path</span> <span class="o">/</span> <span class="s2">&quot;query_templates.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">query_templates</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">query_templates</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">create_query_key_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Use the manual evaluation to create a dictionary of queries and their corresponding ground truth dataset ids. eg: Math,&quot;45617,43383,2,45748&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_key_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_templates</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_eval_queries</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
                <span class="n">new_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">new_query</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_key_dict</span><span class="p">:</span>
                    <span class="n">query_key_dict</span><span class="p">[</span><span class="n">new_query</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">query_key_dict</span>

    <span class="k">def</span> <span class="nf">preprocess_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Preprocess the results dataframe by filling missing values and converting the columns to the correct data types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;llm_before_rag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;llm_before_rag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="s2">&quot;No LLM filtering&quot;</span>
        <span class="p">)</span>
        <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;y_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;y_pred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;y_true&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_key_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results_df</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_precision</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Compute the precision metric for each group in the dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_true&quot;</span><span class="p">],</span> <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_pred&quot;</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">grouped_df</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_recall</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Compute the recall metric for each group in the dataframe</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_true&quot;</span><span class="p">],</span> <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_pred&quot;</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">grouped_df</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_map</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description: Compute the mean average precision metric for each group in the dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:</span><span class="n">i</span><span class="p">])))</span> <span class="o">/</span> <span class="n">i</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)))</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_true&quot;</span><span class="p">],</span> <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_pred&quot;</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">grouped_df</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">display_results</span><span class="p">(</span><span class="n">results_df</span><span class="p">):</span>
        <span class="c1"># add more preprocessing here</span>
        <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>
        <span class="c1"># heatmap results</span>
        <span class="c1"># return results_df.style.background_gradient(cmap=&#39;coolwarm&#39;, axis=0)</span>
        <span class="k">return</span> <span class="n">results_df</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="evaluation_utils.EvaluationProcessor.add_map" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_map</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#evaluation_utils.EvaluationProcessor.add_map" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Compute the mean average precision metric for each group in the dataframe</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">add_map</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Compute the mean average precision metric for each group in the dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:</span><span class="n">i</span><span class="p">])))</span> <span class="o">/</span> <span class="n">i</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)))</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_true&quot;</span><span class="p">],</span> <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_pred&quot;</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">grouped_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="evaluation_utils.EvaluationProcessor.add_precision" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_precision</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#evaluation_utils.EvaluationProcessor.add_precision" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Compute the precision metric for each group in the dataframe</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">add_precision</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Compute the precision metric for each group in the dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_true&quot;</span><span class="p">],</span> <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_pred&quot;</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">grouped_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="evaluation_utils.EvaluationProcessor.add_recall" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_recall</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#evaluation_utils.EvaluationProcessor.add_recall" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Compute the recall metric for each group in the dataframe</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">add_recall</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Compute the recall metric for each group in the dataframe</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_true&quot;</span><span class="p">],</span> <span class="n">grouped_df</span><span class="p">[</span><span class="s2">&quot;y_pred&quot;</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">grouped_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="evaluation_utils.EvaluationProcessor.create_query_key_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_query_key_dict</span><span class="p">()</span></code>

<a href="#evaluation_utils.EvaluationProcessor.create_query_key_dict" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Use the manual evaluation to create a dictionary of queries and their corresponding ground truth dataset ids. eg: Math,"45617,43383,2,45748"</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_query_key_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Use the manual evaluation to create a dictionary of queries and their corresponding ground truth dataset ids. eg: Math,&quot;45617,43383,2,45748&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query_key_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_templates</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_eval_queries</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">new_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">new_query</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_key_dict</span><span class="p">:</span>
                <span class="n">query_key_dict</span><span class="p">[</span><span class="n">new_query</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">query_key_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="evaluation_utils.EvaluationProcessor.generate_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_results</span><span class="p">(</span><span class="n">csv_files</span><span class="p">)</span></code>

<a href="#evaluation_utils.EvaluationProcessor.generate_results" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Load the results from the csv files, group them and compute metrics for each group. Then merge the results and sort them by the metric specified.</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_files</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Load the results from the csv files, group them and compute metrics for each group. Then merge the results and sort them by the metric specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">exp_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">csv_files</span><span class="p">):</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">exp_path</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;did&quot;</span><span class="p">:</span> <span class="s2">&quot;y_pred&quot;</span><span class="p">})</span>
        <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;exp_folder_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">exp_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
        <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;custom_experiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># split exp_folder_name by @ to get extra information</span>
        <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;custom_experiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s2">&quot;exp_folder_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">exp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;exp_folder_name&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_results</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

        <span class="n">grouped_results_for_y_true_and_pred</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;embedding_model&quot;</span><span class="p">,</span>
                <span class="s2">&quot;llm_model&quot;</span><span class="p">,</span>
                <span class="s2">&quot;query&quot;</span><span class="p">,</span>
                <span class="s2">&quot;llm_before_rag&quot;</span><span class="p">,</span>
                <span class="s2">&quot;custom_experiment&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;y_true&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="s2">&quot;y_pred&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">})</span>

        <span class="n">grouped_results_for_y_true_and_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_metrics</span><span class="p">(</span>
            <span class="n">grouped_results_for_y_true_and_pred</span>
        <span class="p">)</span>

        <span class="c1"># aggregate by computing the average of the metrics for each group</span>
        <span class="n">grouped_results_for_y_true_and_pred</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">grouped_results_for_y_true_and_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;embedding_model&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;llm_model&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;llm_before_rag&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;custom_experiment&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="n">metric</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">})</span>
        <span class="p">)</span>

        <span class="c1"># merge with the results</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">grouped_results_for_y_true_and_pred</span><span class="p">])</span>

        <span class="c1"># sort by metric</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_by</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="evaluation_utils.EvaluationProcessor.load_queries_from_csv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_queries_from_csv</span><span class="p">()</span></code>

<a href="#evaluation_utils.EvaluationProcessor.load_queries_from_csv" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Load the queries from the csv file</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_queries_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Load the queries from the csv file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_path</span> <span class="o">/</span> <span class="s2">&quot;merged_labels.csv&quot;</span><span class="p">)[</span>
        <span class="p">[</span><span class="s2">&quot;Topics&quot;</span><span class="p">,</span> <span class="s2">&quot;Dataset IDs&quot;</span><span class="p">]</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="evaluation_utils.EvaluationProcessor.load_query_templates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_query_templates</span><span class="p">()</span></code>

<a href="#evaluation_utils.EvaluationProcessor.load_query_templates" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Load the query templates from the txt file. This is used to generate the queries for the evaluation process. eg: {query_template} {query}
{find me a dataset about} {cancer}</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_query_templates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Load the query templates from the txt file. This is used to generate the queries for the evaluation process. eg: {query_template} {query}</span>
<span class="sd">    {find me a dataset about} {cancer}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_path</span> <span class="o">/</span> <span class="s2">&quot;query_templates.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">query_templates</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">query_templates</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="evaluation_utils.EvaluationProcessor.load_result_files" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_result_files</span><span class="p">()</span></code>

<a href="#evaluation_utils.EvaluationProcessor.load_result_files" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Find all the csv files in the evaluation directory.</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_result_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Find all the csv files in the evaluation directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_path</span> <span class="o">/</span> <span class="s2">&quot;*/*/results.csv&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="evaluation_utils.EvaluationProcessor.preprocess_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">preprocess_results</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span></code>

<a href="#evaluation_utils.EvaluationProcessor.preprocess_results" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Preprocess the results dataframe by filling missing values and converting the columns to the correct data types.</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">preprocess_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Preprocess the results dataframe by filling missing values and converting the columns to the correct data types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;llm_before_rag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;llm_before_rag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
        <span class="s2">&quot;No LLM filtering&quot;</span>
    <span class="p">)</span>
    <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;y_pred&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;y_pred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;y_true&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_key_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="evaluation_utils.EvaluationProcessor.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

<a href="#evaluation_utils.EvaluationProcessor.run" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Description: Load files, Run the evaluation process and display the results</p>

            <details class="quote">
              <summary>Source code in <code>evaluation/evaluation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Load files, Run the evaluation process and display the results</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_result_files</span><span class="p">()</span>
    <span class="n">results_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_results</span><span class="p">(</span><span class="n">csv_files</span><span class="p">)</span>
    <span class="n">results_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_results</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results_display</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="elastic-search-eval">Elastic Search Eval<a class="headerlink" href="#elastic-search-eval" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="get_elastic_search_results"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">











  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>